<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="Hugo 0.18" />
    <link rel="shortcut icon" href="/images/favicon.ico">
    <link href="https://wadahana.github.io/index.xml" rel="alternate" type="application/rss+xml" title="wadahana&#39;s github pages" />
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    
    <script src="https://wadahana.github.io/js/highlight.pack.js"></script>
    <link rel="stylesheet" href="https://wadahana.github.io/css/styles/monokai-sublime.css">
    <script>hljs.initHighlightingOnLoad();</script>
    
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <title>iOS UIWebView PageCache | wadahana&#39;s github pages</title>
  </head>
  <body>
    <div id="wrap">
      
      <header class="site-header">
        <div class="site-header-left">
          <a class="site-header-title" href="https://wadahana.github.io/">wadahana&#39;s github pages</a>
        </div>
      </header>
      <div class="container">
        <div id="main">

<div class="article">
  <header>
    <div class="article-header">
      <h1>iOS UIWebView PageCache</h1>
      <div class="article-meta">
        <span class="posttime">December 24, 2016</span>
        
<div class="tags">
  <ul>
    
    <li>
        <a href="/tags/ios">iOS</a>
    </li>
    
    <li>
        <a href="/tags/uiwebview">UIWebView</a>
    </li>
    
    <li>
        <a href="/tags/pagecache">PageCache</a>
    </li>
    
    <li>
        <a href="/tags/%E5%89%8D%E8%BF%9B">前进</a>
    </li>
    
    <li>
        <a href="/tags/%E5%90%8E%E9%80%80">后退</a>
    </li>
    
    <li>
        <a href="/tags/%E4%B8%8D%E5%88%B7%E6%96%B0">不刷新</a>
    </li>
    
  </ul>
</div>


      </div>
    </div>
    

  </header>
  <div class="content">
    <p>UIWebView很弱，前进后退的时候会reload，比如浏览&rdquo;今日头条&rdquo;, &ldquo;taobao&rdquo; 或者 &ldquo;渣浪&rdquo; 的时候，从某个条目的detail页面返回列表时会重新刷新并回到列表页面的头部，用户体验很差，老板和产品总爱说: &ldquo;为什么人家UC做的到?&rdquo;</p>

<p>iOS8之后放出的WKWebView倒是不错，性能各方面都和Safari差不多，也没有这些reload的问题。不过WK的网络请求不能通过NSURLProtocol拦截，经过同事“很不细致的调研”发现WK的网络请求是跨进程，而我们需要劫持流量进行计费，WK注定用不了。研究了下UCWeb，用的也是UIWebView。所以我选择相信WK的网络请求拦截解决不了; 最近的研究发现WKWebView虽然是多进程的， 但是它的一部分网络流量也是可以被NSURLProtocol劫持到，需要通过私有API设置下就可以了，不过WKWebView中的音视频确实是没办法劫持。</p>

<p>UIWebView的体系结构［ <a href="http://blog.csdn.net/hursing/article/details/8771847">http://blog.csdn.net/hursing/article/details/8771847</a> ］</p>

<p>这哥们分析的很详细，只是他没告诉我怎么解决前进后退不刷新的问题，而且我把用 &ldquo;UIWebView  goBack&rdquo; 关键字在 stack overflow上搜索出来的所有帖子都看了一遍，并没有发现有用的内容。经过详细的测试，发现可以后退而不刷新页面的浏览器有：UCWeb、 QQ浏览器、百度浏览器、 搜狗浏览器；后退会reload的浏览器：Chrome、Opera、猎豹、海豚、极速浏览器、傲云浏览器、手机百度。</p>

<p>开始我们毫无头绪，由于之前研究过UC在播放视频时，是用JS劫持video对象和load、play调用，然后传递video url到OC Native，再通过弹出Native的VideoView来播放视频，对于某些只有广告链接或者收费视频或者APP专享的视频，怀疑UC是有一套后端视频URL的聚合系统，可能通过ref url在后端查询真实的视频url来播放，不可否认UC在视频上做的非常的屌。有这个先入为主的惯性思维，一开始怀疑UC也是用JS解决前进后退不刷新的问题。为了验证这个想法，我们用MobileSubstrate注入动态库 [ <a href="http://blog.jobbole.com/58856/">http://blog.jobbole.com/58856/</a> ] 到UC的进程空间里， Method Swizzling [ <a href="http://blog.csdn.net/yiyaaixuexi/article/details/9374411">http://blog.csdn.net/yiyaaixuexi/article/details/9374411</a> ] 替换UIWebView的 stringByEvaluatingJavaScriptFromString函数并直接返回，失效掉UCWeb对UIWebView所有额外的插入的js脚本，然而并非如此。</p>

  </div>
  <footer>
    <div class="article-footer">
      
<div class="tags">
  <ul>
    
    <li>
        <a href="/tags/ios">iOS</a>
    </li>
    
    <li>
        <a href="/tags/uiwebview">UIWebView</a>
    </li>
    
    <li>
        <a href="/tags/pagecache">PageCache</a>
    </li>
    
    <li>
        <a href="/tags/%E5%89%8D%E8%BF%9B">前进</a>
    </li>
    
    <li>
        <a href="/tags/%E5%90%8E%E9%80%80">后退</a>
    </li>
    
    <li>
        <a href="/tags/%E4%B8%8D%E5%88%B7%E6%96%B0">不刷新</a>
    </li>
    
  </ul>
</div>


      
      

      
      
      <div id="pagenavigation-next-prev">
        
        <div id="pagenavigation-next">
          <span class="pagenav-label">Previous</span>
          <a href="https://wadahana.github.io/post/android-elf-hook/">Android ELF Hook</a>
        </div>
        
        
      </div>
      
    </div>
  </footer>
</div>
        </div>
        <div class="sidebar">
  
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Author</span>
    </div>
    <div id="author">
      <span>eric woo</span>
      <div>
        
        
        <a href="https://github.com/wadahana"><i class="fa fa-github-square fa-2x" aria-hidden="true"></i></a>
        
        
        <a href="https://www.linkedin.com/in/eric-woo-97ba8481"><i class="fa fa-linkedin-square fa-2x" aria-hidden="true"></i></a>
        
      </div>
    </div>
  </div>
  
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Categories</span>
    </div>
    <div class="categories">
      <ul>
        
        <li>
          <a href="/categories/api-hook"><span></span>api-hook (1)</a>
        </li>
        
        <li>
          <a href="/categories/%E7%A7%BB%E5%8A%A8%E5%BC%80%E5%8F%91"><span></span>移动开发 (2)</a>
        </li>
        
        <li>
          <a href="/categories/%E7%BD%91%E7%BB%9C%E5%8A%AB%E6%8C%81"><span></span>网络劫持 (2)</a>
        </li>
        
      </ul>
    </div>
  </div>
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>RSS</span>
    </div>
    <div id="rss">
      <a href="https://wadahana.github.io/index.xml" type="application/rss+xml" target="_blank">
        <i class="fa fa-rss-square fa-2x" aria-hidden="true"></i>
      </a>
    </div>
  </div>
</div>

      </div>
      <footer>
        <div id="site-footer-wrap">
          <div id="site-footer">
            <span>Powered by <a href="https://gohugo.io/">Hugo</a>.</span>
            <span>
              
              Copyright (c) 2016, <a href="https://wadahana.github.io/">wadahana&#39;s github pages</a>
              
            </span>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>

